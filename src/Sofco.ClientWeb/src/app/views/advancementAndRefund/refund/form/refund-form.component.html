<div class="alert alert-gaps-error" *ngIf="differentCurrenciesWereSelected">
    <i class="fa fa-warning"></i>
    {{ i18nService.translate('advancementAndRefund/refund','differentCurrencies') }}
</div>

<form [formGroup]="form" *ngIf="form">

    <div class="row">
        <div class="col-md-6">
            <div class="form-group" [ngClass]="form.controls.userApplicantId.invalid ? 'has-error' : 'has-success'">
                <label style="font-size: 15px"> {{'refund.userApplicant' | translate }}: </label>
                <span style="font-size: 14px"> {{ userApplicantName }}</span>
        
                <div class="form-control-feedback" *ngIf="form.controls.userApplicantId.invalid">
                    <p>{{ i18nService.translate('advancementAndRefund/refund','userApplicantRequired') }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <label style="font-size: 15px" class="label pull-right" [ngClass]="getStatusClass()">{{ status }}</label>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="form-group" [ngClass]="formsService.getClassProperty(form, 'advancements')">
                <label class="control-label"> {{ 'refund.advancements' | translate }} </label>
                <ng-select [items]="advancements" [multiple]="true" [closeOnSelect]="true" bindValue="id" bindLabel="text" formControlName="advancements" (change)="advancementsChanged()"></ng-select>
        
                <div class="form-control-feedback" *ngIf="formsService.hasErrors(form, 'advancements')">
                    <p *ngIf="formsService.hasError(form, 'advancements', 'required')">{{ i18nService.translate('advancementAndRefund/refund','advancementRequired') }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <dl>
                <dt><strong> {{'refund.currency' | translate }}: </strong></dt>
                <dd> {{ currencyDescription }} </dd>
            </dl>
        </div>
    </div>

    <div class="form-group" [ngClass]="formsService.getClassProperty(form, 'analyticId')">
        <label class="control-label">{{ 'refund.contract' | translate }}</label>
        <ng-select [items]="analytics" bindValue="id" bindLabel="text" formControlName="analyticId"></ng-select>

        <div class="form-control-feedback" *ngIf="formsService.hasErrors(form, 'analyticId')">
            <p *ngIf="formsService.hasError(form, 'analyticId', 'required')">{{ i18nService.translate('advancementAndRefund/refund','analyticRequired') }}</p>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-6">
            <h2>{{ 'refund.details' | translate }}</h2>
        </div>
        <div class="col-xs-6 text-right">
            <button type="button" class="btn btn-success btn-sm" (click)="addDetail()">
                {{ 'ACTIONS.ADD' | translate }}
                <i class="fa fa-plus"></i>
            </button>
        </div>
    </div>

    <div class="alert alert-gaps-info" style="margin-top: 10px" *ngIf="detailForms.length == 0">
        <i class="fa fa-info-circle"></i>
        {{ 'refund.noDetailsInfo' | translate }}
    </div>

    <table class="table table-striped dataTable" role="grid" *ngIf="detailForms.length > 0">
        <thead>
            <tr>
                <th>{{ 'advancement.date' | translate }}</th>
                <th>{{ 'advancement.description' | translate }}</th>
                <th>{{ 'advancement.ammount' | translate }}</th>
                <th class="text-center column-xs">{{ 'ACTIONS.title' | translate }}</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let detail of detailForms; let i = index" class="pointer">
                <td>{{ detail.controls.creationDate.value | date: 'dd/MM/yyyy' }}</td>
                <td class="column-xlg text-word-break">{{ detail.controls.description.value }}</td>
                <td>{{ detail.controls.ammount.value | currency: '$' }}</td>
                <td class="text-center column-xs">
                    <button class="btn btn-sm fa fa-pencil btn-warning" (click)="editDetail(detail, i)"></button>
                    <button class="btn btn-sm fa fa-trash btn-danger" (click)="removeDetail(i)"></button>
                </td>
            </tr>
        </tbody>
    </table>   

    <div class="row">
        <div class="col-xs-4">
            <dl>
                <dt><strong> Total gastos: </strong></dt>
                <dd> {{ refundSum }} {{ currencyDescription }} </dd>
            </dl>
        </div>
        <div class="col-xs-4">
            <dl>
                <dt><strong> Total Adelantos: </strong></dt>
                <dd> {{ advancementSum }} {{ currencyDescription }} </dd>
            </dl>
        </div>
        <div class="col-xs-4">
            <dl>
                <dt><strong> Total a Reembolsar: </strong></dt>
                <dd> {{ differenceSum }} {{ currencyDescription }} </dd>
            </dl>
        </div>
    </div>
</form> 

<ng2-modal [config]="addDetailModalConfig" #addDetailModal (accept)="saveDetail()" (close)="onClose()" [isSaveEnabled]="detailModalForm.valid">
    <form [formGroup]="detailModalForm" *ngIf="detailModalForm">   
        <div class="form-group" [ngClass]="formsService.getClassProperty(detailModalForm, 'creationDate')">
            <label class="control-label">{{ 'refund.date' | translate }}</label>
            <input type="text" class="form-control" #dp="bsDatepicker" bsDatepicker formControlName="creationDate">

            <div class="form-control-feedback" *ngIf="formsService.hasErrors(detailModalForm, 'creationDate')">
                <p *ngIf="formsService.hasError(detailModalForm, 'creationDate', 'required')">{{ i18nService.translate('advancementAndRefund/refund','detailDateRequired') }}</p>
            </div>
        </div>

        <div class="form-group" [ngClass]="formsService.getClassProperty(detailModalForm, 'description')">
            <label class="control-label">{{ 'advancement.description' | translate }}</label>
            <input type="text" class="form-control" formControlName="description">

            <div class="form-control-feedback" *ngIf="formsService.hasErrors(detailModalForm, 'description')">
                <p *ngIf="formsService.hasError(detailModalForm, 'description', 'required')">{{ i18nService.translate('advancementAndRefund/refund','detailDescriptionRequired') }}</p>
                <p *ngIf="formsService.hasError(detailModalForm, 'description', 'maxLength')">{{ i18nService.translate('advancementAndRefund/refund','descriptionItemMaxLength') }}</p>
            </div>
        </div>

        <div class="form-group" [ngClass]="formsService.getClassProperty(detailModalForm, 'ammount')">
            <label class="control-label">{{ 'advancement.ammount' | translate }}</label>
            <input type="number" decimalFormat class="form-control" formControlName="ammount">

            <div class="form-control-feedback" *ngIf="formsService.hasErrors(detailModalForm, 'ammount')">
                <p *ngIf="formsService.hasError(detailModalForm, 'ammount', 'required')">{{ i18nService.translate('advancementAndRefund/refund','detailAmmountRequired') }}</p>
                <p *ngIf="formsService.hasError(detailModalForm, 'ammount', 'max')">{{ i18nService.translate('advancementAndRefund/refund','ammountItemMax') }}</p>
                <p *ngIf="formsService.hasError(detailModalForm, 'ammount', 'min')">{{ i18nService.translate('advancementAndRefund/refund','ammountItemMin') }}</p>
            </div>
        </div>
    </form>
</ng2-modal> 